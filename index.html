<!DOCTYPE html>
    <head>
        <script src="lib/eshot.js"></script>
        <link rel="stylesheet" href="lib/eshot.css"/>
    </head>
<body>
    <div id="controls">
        <label for="txtStopId">Stop #</label>
        <input type="text" id="txtStopId" size="5" onkeydown="txtStopId_keydown(this)"/>
        <input type="button" id="btnGetBusLocations" value="Get Bus Locations" onclick="btnGetBusLocations_click()"/>
        <img id="eshot-logo" src="images/eshot-logo.png" />
    </div>

    <label id="lblStatus"></label>

    <div id="schedule"><table id="schedule-ul"></table></div>

    <script type="text/javascript">

        function loadUrlParams() {
            const params = new URLSearchParams(document.location.search);
            const stopid = params.get("stopid");
            if (stopid && stopid.startsWith('500') && stopid.length < 6) {
                document.getElementById('txtStopId').value = stopid;
            }
        }

        function saveUrlParam(name, value) {
            const params = new URLSearchParams(document.location.search);
            params.set(name, value);
            origin = window.location.origin;
            origin = (origin !== 'null') || 'file://';
            url = origin + window.location.pathname + '?' + params.toString();
            console.log(window.location);
            history.pushState(history.state, document.title, url);
        }

        var timeoutId = null;

        function btnGetBusLocations_click() {
            var lblStatus = document.getElementById('lblStatus');
            var txtStopId = document.getElementById('txtStopId');

            if (!lblStatus.innerText.startsWith('Last')) { 
                lblStatus.innerText = '';
            } else {
                if (txtStopId.value == '' && !lblStatus.innerText.endsWith('(paused)')) {
                    lblStatus.innerText = lblStatus.innerText + ' (paused)';                    
                }    
            }

            if (txtStopId.value == '') return; 

            lblStatus.innerText = 'Fetching...';

            EshotService.getBusLocationsForStop(txtStopId.value, function(data) {
                updateBusLocations(data);
                lblStatus.innerText = 'Last updated: ' + new Date().toLocaleTimeString();
                
                if (timeoutId != null) clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    btnGetBusLocations_click();
                }, 20000);

                if (txtStopId.value && txtStopId.value.startsWith('500') && txtStopId.value.length < 6) {
                    saveUrlParam('stopid', txtStopId.value);                
                }

            }, function(e){
                console.error("Exception thrown", e);
                lblStatus.innerText = e;
            });            
        }

        function txtStopId_keydown(ele) {
            if (event.key === 'Enter') {
                btnGetBusLocations_click();
            }
        }

        function addTableData(row, text){
            var td = document.createElement('td');
            td.innerText = text;
            row.appendChild(td);
        }

        function updateBusLocations(data) {
            var schedule_ul = document.getElementById('schedule-ul');
            schedule_ul.innerHTML = '';
            data.forEach(bus => {
                var awayLabel = bus.KalanDurakSayisi == 0 ? 'arriving' : bus.KalanDurakSayisi + ' stops away';
                var busNumber = "" + bus.HatNumarasi;
                var row = document.createElement('tr');
                addTableData(row, busNumber);
                addTableData(row, bus.HatAdi);
                addTableData(row, awayLabel);
                schedule_ul.appendChild(row);
            });
        }

        loadUrlParams();
        
     </script>
</body>
</html>